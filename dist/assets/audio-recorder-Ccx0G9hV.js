let o=null,c=[],a=!1,u=null;async function h(){try{if(console.log("üé§ D√©marrage enregistrement vocal..."),a)return console.log("Enregistrement d√©j√† en cours"),!1;if(!window.currentChat)return s("S√©lectionnez une conversation d'abord","error"),!1;const e=await navigator.mediaDevices.getUserMedia({audio:!0});return o=new MediaRecorder(e),c=[],u=Date.now(),a=!0,o.ondataavailable=t=>{t.data.size>0&&c.push(t.data)},o.onstop=async()=>{if(console.log("Arr√™t enregistrement"),e.getTracks().forEach(n=>n.stop()),c.length===0){s("Erreur: aucune donn√©e audio","error"),d();return}const t=new Blob(c,{type:"audio/webm"}),r=Math.round((Date.now()-u)/1e3);await x(t,r),a=!1,d()},o.start(),g(!0),s("üé§ Enregistrement en cours...","info"),!0}catch(e){return console.error("Erreur enregistrement:",e),s("Erreur: "+e.message,"error"),a=!1,d(),!1}}function b(){o&&a&&(console.log("Arr√™t de l'enregistrement..."),o.stop(),s("üì§ Envoi du message vocal...","info"))}function g(e){const t=document.getElementById("voiceBtn");t&&(e?(t.innerHTML='<i class="fas fa-stop text-xl text-red-500"></i>',t.classList.add("recording")):(t.innerHTML='<i class="fas fa-microphone text-xl"></i>',t.classList.remove("recording")))}function d(){g(!1),a=!1}async function x(e,t){try{const r=m(),n=window.currentChat;if(!r||!n){s("Erreur: utilisateur ou chat non d√©fini","error");return}console.log("üì§ Envoi message vocal...");const f=await w(e),l={id:Date.now(),senderId:r.id,receiverId:n.contactId,text:"üé§ Message vocal",sent:!0,time:new Date().toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}),timestamp:new Date().toISOString(),type:"voice",fileData:f,duration:t,status:"sent"},v=p(l),i=document.getElementById("messagesArea");i&&(i.appendChild(v),i.scrollTop=i.scrollHeight),window.handleSendMessage&&await window.handleSendMessage(r.id,n.contactId,l),s("‚úÖ Message vocal envoy√©","success")}catch(r){console.error("Erreur envoi message vocal:",r),s("‚ùå Erreur lors de l'envoi","error")}}function p(e){const t=m(),r=e.senderId===t.id,n=document.createElement("div");return n.className=`flex mb-4 ${r?"justify-end":"justify-start"}`,n.innerHTML=`
    <div class="max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${r?"bg-[#005c4b] text-white":"bg-[#202c33] text-white"} shadow-md">
      <div class="flex items-center space-x-2">
        <button class="voice-play-btn w-8 h-8 rounded-full bg-green-500 flex items-center justify-center">
          <i class="fas fa-play text-xs text-white"></i>
        </button>
        <div class="flex-1">
          <div class="text-sm">üé§ Message vocal</div>
          <div class="text-xs text-gray-300">${e.duration}s</div>
        </div>
      </div>
      <div class="flex justify-end items-center mt-1">
        <span class="text-xs text-gray-300">${e.time}</span>
      </div>
    </div>
  `,n}function w(e){return new Promise((t,r)=>{const n=new FileReader;n.onloadend=()=>t(n.result),n.onerror=r,n.readAsDataURL(e)})}function m(){const e=localStorage.getItem("currentUser");return e?JSON.parse(e):null}function s(e,t){console.log(`[${t.toUpperCase()}] ${e}`);const r=document.createElement("div");r.className=`fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 ${t==="success"?"bg-green-500":t==="error"?"bg-red-500":"bg-blue-500"}`,r.textContent=e,document.body.appendChild(r),setTimeout(()=>{r.parentNode&&r.parentNode.removeChild(r)},3e3)}export{h as startVoiceRecording,b as stopVoiceRecording};
